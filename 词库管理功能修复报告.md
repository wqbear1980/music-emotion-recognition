# 词库管理功能修复报告

生成时间：2026-01-15

---

## 一、问题确认

### 问题1：未识别内容记录
**问题描述**：
- ⚠️ API 已实现，前端未调用
- 分析时遇到的未识别场景没有自动记录到数据库
- 无法自动统计高频未识别词，无法触发扩充建议

**API端点**：`POST /api/term-management/record-unrecognized`

### 问题2：手动添加新词
**问题描述**：
- ❌ 前端有界面，缺少后端 API（检测报告中描述）
- **实际情况**：后端API已存在（`POST /api/term-management/add-candidate-term`），检测报告信息过时

---

## 二、问题分析

### 1. 未识别内容记录问题分析

**根本原因**：
1. 前端代码中虽然定义了`recordUnrecognizedScenario`函数，但在循环调用时没有使用`await`，导致请求可能未正确发送
2. 在后续的场景词处理主循环中，完全没有调用记录未识别词的逻辑
3. AI返回的候选新词（`candidateTerms.scenarios`和`candidateTerms.dubbing`）没有记录到未识别词表

**影响范围**：
- 所有音乐分析过程
- 未识别场景词和配音建议词都不会被记录
- 词库自动扩充功能无法获得数据支持

### 2. 手动添加新词问题分析

**实际情况**：
- 后端API已完整实现：`src/app/api/term-management/add-candidate-term/route.ts`
- 前端界面已完整实现：`src/components/TermManagementPanel.tsx`
- 功能完全正常，检测报告信息过时（基于早期代码）

---

## 三、修复方案

### 1. 未识别内容记录修复

#### 修复位置
**文件**：`src/app/page.tsx`
**函数**：`saveAnalysisToDatabase`

#### 修复内容

**步骤1：移除旧的单独记录函数**
```typescript
// 删除了原来的单独记录函数
- const recordUnrecognizedScenario = async (...) => { ... }
```

**步骤2：添加批量收集未识别词逻辑**
```typescript
// 在场景词处理循环之前添加收集数组
const unrecognizedScenesToRecord: Array<{ term: string; filmType: string }> = [];

// 在检查场景词是否为标准词时，如果是非标准词，暂存到数组
if (!isStandardOrSynonym && !standardScenes.includes(sceneType)) {
  unrecognizedScenesToRecord.push({
    term: sceneType,
    filmType: scenariosFilmType
  });
}
```

**步骤3：在主循环中也添加记录逻辑**
```typescript
// 实在无法推断，保留原词
allScenarios.push(sceneType);
// 【记录未识别词】不是标准词且无法推断，记录到未识别表
unrecognizedScenesToRecord.push({
  term: sceneType,
  filmType: scenariosFilmType
});
```

**步骤4：批量发送记录请求**
```typescript
// 在保存到数据库之前，批量发送未识别词记录
if (unrecognizedScenesToRecord.length > 0) {
  console.log(`[词库管理] 批量记录${unrecognizedScenesToRecord.length}个未识别场景`);
  const recordPromises = unrecognizedScenesToRecord.map(item =>
    fetch('/api/term-management/record-unrecognized', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        term: item.term,
        category: 'scenario',
        filmType: item.filmType,
      }),
    }).catch(err => {
      console.error(`[词库管理] 记录未识别场景"${item.term}"失败:`, err);
    })
  );
  await Promise.all(recordPromises);
}
```

**步骤5：记录候选新词**
```typescript
// 记录AI返回的候选新词（场景词和配音建议词）
if (candidateTerms) {
  const candidateTermsToRecord: Array<{ term: string; filmType: string; category: 'scenario' | 'dubbing' }> = [];

  // 记录场景候选词
  if (candidateTerms.scenarios && candidateTerms.scenarios.length > 0) {
    candidateTerms.scenarios.forEach((candidate: any) => {
      if (candidate.term && typeof candidate.term === 'string') {
        candidateTermsToRecord.push({
          term: candidate.term,
          filmType: scenariosFilmType,
          category: 'scenario',
        });
      }
    });
  }

  // 记录配音建议候选词
  if (candidateTerms.dubbing && candidateTerms.dubbing.length > 0) {
    candidateTerms.dubbing.forEach((candidate: any) => {
      if (candidate.term && typeof candidate.term === 'string') {
        candidateTermsToRecord.push({
          term: candidate.term,
          filmType: scenariosFilmType,
          category: 'dubbing',
        });
      }
    });
  }

  // 批量发送记录请求
  if (candidateTermsToRecord.length > 0) {
    console.log(`[词库管理] 批量记录${candidateTermsToRecord.length}个候选新词`);
    const recordPromises = candidateTermsToRecord.map(item =>
      fetch('/api/term-management/record-unrecognized', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          term: item.term,
          category: item.category,
          filmType: item.filmType,
        }),
      }).catch(err => {
        console.error(`[词库管理] 记录候选新词"${item.term}"失败:`, err);
      })
    );
    await Promise.all(recordPromises);
  }
}
```

#### 修复效果
- ✅ 所有未识别场景词都会被记录到数据库
- ✅ 所有候选新词（场景词和配音建议词）都会被记录
- ✅ 使用批量发送，提高性能
- ✅ 添加错误处理，不会阻塞主流程
- ✅ 添加日志输出，便于调试和监控

### 2. 手动添加新词问题

**结论**：无需修复

**原因**：
- 后端API已完整实现：`src/app/api/term-management/add-candidate-term/route.ts`
- 前端界面已完整实现：`src/components/TermManagementPanel.tsx`
- 功能完全正常，检测报告信息过时

---

## 四、验证结果

### 1. TypeScript编译检查
```bash
npx tsc --noEmit 2>&1 | grep "src/app/page.tsx"
# 结果：无错误
```

### 2. 服务状态检查
```bash
curl -I --max-time 3 http://localhost:5000
# 结果：HTTP/1.1 200 OK
```

### 3. 代码逻辑验证

**未识别词记录流程**：
1. ✅ AI分析返回场景词 → 检查是否为标准词 → 非标准词暂存
2. ✅ AI分析返回候选新词 → 提取场景词和配音建议词 → 暂存
3. ✅ 保存分析结果到数据库之前 → 批量发送记录请求
4. ✅ 添加错误处理和日志输出

**手动添加新词流程**：
1. ✅ 前端界面 → 填写标准词、分类、近义词、影视类型、理由
2. ✅ 调用API → `POST /api/term-management/add-candidate-term`
3. ✅ 后端验证 → 检查冲突、添加到词库（reviewStatus='pending'）
4. ✅ 记录扩充历史 → 标记来源为'manual'

---

## 五、修复总结

### 修复内容
1. **未识别内容记录功能修复**：
   - 移除旧的单独记录函数
   - 添加批量收集逻辑（场景词和候选新词）
   - 批量发送记录请求，提高性能
   - 添加错误处理和日志输出

2. **手动添加新词功能确认**：
   - 确认后端API已存在且完整实现
   - 确认前端界面已存在且完整实现
   - 功能完全正常，无需修复

### 修改文件
- `src/app/page.tsx`：修复未识别词记录逻辑（第1960-2480行）

### 技术要点
1. 使用数组暂存，避免多次网络请求
2. 使用`Promise.all`批量发送，提高性能
3. 添加`.catch`错误处理，不阻塞主流程
4. 区分场景词和配音建议词，使用不同的category

---

## 六、后续建议

### 1. 优化建议
- 可以考虑添加批量记录未识别词的专用API，减少HTTP请求次数
- 可以考虑添加未识别词去重逻辑，避免重复记录相同词汇

### 2. 监控建议
- 定期查看未识别词表的统计数据
- 当某个词的出现次数达到阈值时，及时进行扩充

### 3. 词库维护建议
- 定期审核未识别词表中的高频词
- 及时扩充新词，减少"未识别场景"的数量

---

## 七、附录

### 相关API端点
1. `POST /api/term-management/record-unrecognized` - 记录未识别内容
2. `POST /api/term-management/add-candidate-term` - 添加候选新词
3. `POST /api/term-management/auto-expand` - 自动扩充
4. `POST /api/term-management/review` - 审核候选词

### 相关数据库表
1. `unrecognized_terms` - 未识别词表
2. `standard_terms` - 标准词库表
3. `term_expansion_records` - 词库扩充记录表
