# 映射表导入功能测试文档

## 一、功能改进概述

### 1. 改进内容

**双词库同步机制**
- 映射表导入同时更新静态词库文件和数据库
- 支持自动审核通过和待审核两种模式
- 导入成功后自动刷新动态词库缓存

### 2. 核心改进点

| 功能模块 | 改进前 | 改进后 |
|---------|-------|-------|
| 数据写入 | 只写入文件 | 同时写入文件和数据库 |
| 审核流程 | 不支持 | 支持自动审核/待审核 |
| 分析生效 | 仅静态词库 | 动态词库优先 |
| 词库刷新 | 不支持 | 自动刷新动态词库 |

---

## 二、测试流程

### 测试场景1：自动审核通过模式（推荐）

#### 步骤1：准备测试数据

1. 进入"数据库管理" → "映射表管理"
2. 选择"标准场景词"分类
3. 点击"导出映射表"，选择 Excel 格式
4. 下载并打开导出的文件

#### 步骤2：编辑测试数据

在 Excel 文件中添加测试词汇：

```
标准词        原词          适配类型
测试场景A     测试场景A
测试场景B     测试B         动作片,悬疑片
咖啡厅闲聊   闲聊          都市剧
```

保存文件（如 `test_scenes.xlsx`）。

#### 步骤3：导入映射表

1. 返回映射表管理页面
2. 选择"导入映射表"标签
3. 配置选项：
   - 选择映射表：标准场景词
   - 导入模式：追加模式
   - 审核状态：✅ 自动审核通过（勾选）
4. 上传编辑后的 Excel 文件
5. 点击"预览导入"
6. 确认数据无误后，点击"确认导入"

#### 步骤4：验证导入结果

**预期提示信息：**
```
✅ 导入成功！
📄 静态词库已更新
🗄️ 动态词库已同步
📊 数据库统计：新增 3 条，更新 0 条
📝 审核状态：已通过
```

**验证点：**
1. ✅ 导入成功提示包含数据库统计信息
2. ✅ 控制台输出：`[映射表管理] 已刷新动态词库`

#### 步骤5：验证词库生效

**方法1：查看数据库**
1. 进入"词库管理" → "词库查询"
2. 筛选条件：分类=场景，审核状态=已通过
3. 搜索"测试场景A"，应该能查到

**方法2：分析测试**
1. 回到分析页面
2. 上传任意音乐文件进行分析
3. 检查分析结果，AI 可能会使用新导入的场景词

---

### 测试场景2：待审核模式

#### 步骤1：导入映射表（待审核）

重复测试场景1的步骤1-3，但配置选项改为：
- 审核状态：❌ 自动审核通过（不勾选）

#### 步骤2：审核通过词汇

1. 进入"词库管理" → "审核"标签
2. 应该能看到新导入的词汇（状态：待审核）
3. 勾选"测试场景A"
4. 点击"审核通过"
5. 填写审核意见（可选）
6. 确认审核

#### 步骤3：验证词汇生效

1. 回到分析页面
2. 分析音乐文件
3. 检查结果中是否包含新词汇

---

### 测试场景3：追加模式 vs 替换模式

#### 追加模式测试

1. 导入一组词汇（3条）
2. 再次导入另一组词汇（2条，不重复）
3. 预期结果：数据库中共有 5 条记录

#### 替换模式测试

1. 导入一组词汇（3条）
2. 修改 Excel 文件，保留 1 条原词，添加 2 条新词
3. 使用替换模式导入
4. 预期结果：数据库中只有 3 条记录（保留的1条 + 新增2条）

---

### 测试场景4：重复词处理

#### 测试步骤

1. 导入词汇：咖啡厅闲聊
2. 再次导入相同的词汇，但添加近义词：咖啡闲聊
3. 观察结果：
   - 如果是追加模式：应该合并近义词
   - 统计信息应该显示"更新 1 条"

---

## 三、验证清单

### 功能验证

- [ ] 映射表导出正常（支持 Excel/CSV/JSON）
- [ ] 映射表导入预览正常
- [ ] 自动审核模式导入成功
- [ ] 待审核模式导入成功
- [ ] 数据库写入成功（新增/更新计数正确）
- [ ] 文件更新成功（standardTerms.ts 被修改）
- [ ] 动态词库自动刷新
- [ ] 词库查询能看到新词
- [ ] 分析时能使用新词

### 数据验证

#### 静态词库（文件）
- [ ] `src/lib/standardTerms.ts` 文件已更新
- [ ] 新词添加到对应分类的 standardList
- [ ] 映射关系添加到 mapping 对象

#### 动态词库（数据库）
- [ ] `standard_terms` 表中有新记录
- [ ] reviewStatus 字段正确（approved/pending）
- [ ] expansionSource = 'manual-import'
- [ ] filmTypes 和 synonyms 字段正确
- [ ] termExpansionRecords 表有扩充记录

---

## 四、异常测试

### 测试用例1：文件格式错误

**测试数据：**
- 上传不支持的文件格式（.pdf, .txt）

**预期结果：**
- 提示：不支持的文件格式

---

### 测试用例2：数据格式错误

**测试数据：**
- Excel 文件缺少"标准词"列
- 标准词重复

**预期结果：**
- 预览阶段提示错误
- 不执行导入操作

---

### 测试用例3：数据库连接失败

**测试方法：**
- 关闭数据库服务
- 执行导入操作

**预期结果：**
- 回滚文件更新（从备份恢复）
- 提示数据库写入失败
- 不影响原文件

---

### 测试用例4：近义词冲突

**测试数据：**
- 导入：标准词=测试场景A，原词=咖啡厅
- 但"咖啡厅"已经是另一个标准词

**预期结果：**
- 预览阶段提示冲突
- 不执行导入操作

---

## 五、性能测试

### 测试大批量导入

**测试数据：**
- 导入包含 100+ 条词汇的 Excel 文件

**验证点：**
- [ ] 导入过程不卡顿
- [ ] 数据库写入耗时合理（< 10秒）
- [ ] 动态词库刷新成功

---

## 六、回归测试

### 影响范围

导入功能的修改可能影响以下模块：

- [ ] 映射表导出功能
- [ ] 词库管理功能
- [ ] 分析功能
- [ ] 词库查询功能

### 测试建议

执行导入操作后，验证：
1. 导出功能是否正常
2. 词库管理是否能正常查询新词
3. 分析功能是否能正常使用新词
4. 词库查询是否能过滤新词

---

## 七、日志检查

### 关键日志位置

#### 前端控制台
```
[映射表管理] 已刷新动态词库
[动态词库] 标记需要刷新
[动态词库] 从数据库加载词库...
[动态词库] 加载成功，共 XX 个词汇
```

#### 后端控制台
```
[导入词汇失败] 词名: 错误详情
```

---

## 八、已知限制

1. **部分分类不支持自动导入**
   - 影片类型（细分）
   - 需要手动编辑文件

2. **替换模式的影响范围**
   - 只清空已审核通过的词
   - 不影响待审核和已拒绝的词

3. **近义词处理**
   - 导入时只处理"原词"列作为近义词
   - 复杂的近义词关系建议在词库管理中手动编辑

---

## 九、常见问题

### Q1: 导入成功但词库中没有看到新词？

**检查点：**
1. 确认选择了"自动审核通过"
2. 如果选择了"待审核"，需要到"词库管理" → "审核"中通过
3. 检查筛选条件是否正确

### Q2: 导入后分析时没有使用新词？

**解决方法：**
1. 检查控制台是否有刷新动态词库的日志
2. 手动刷新页面，让动态词库重新加载
3. 确认词汇确实已审核通过

### Q3: 导入失败，如何恢复？

**回滚机制：**
- 数据库写入失败会自动回滚文件更新
- 如果需要完全恢复，使用导出功能的备份数据

---

## 十、测试完成标准

完成以下所有测试用例，并通过验证清单，即可认为功能测试通过：

- [ ] 测试场景1：自动审核通过模式
- [ ] 测试场景2：待审核模式
- [ ] 测试场景3：追加/替换模式
- [ ] 测试场景4：重复词处理
- [ ] 功能验证清单（9项）
- [ ] 数据验证清单（6项）
- [ ] 至少2个异常测试用例
- [ ] 性能测试（100+ 条数据）
- [ ] 回归测试（影响范围验证）

---

## 附录：测试数据模板

### Excel 格式示例

| 标准词 | 原词 | 适配类型 |
|-------|------|---------|
| 测试场景A | 测试场景A | |
| 测试场景B | 测试B | 动作片,悬疑片 |
| 咖啡厅闲聊 | 闲聊 | 都市剧 |
| 夜店狂欢 | 夜店 | 青春片,都市剧 |

### CSV 格式示例

```csv
标准词,原词,适配类型
测试场景A,测试场景A,
测试场景B,测试B,动作片,悬疑片
咖啡厅闲聊,闲聊,都市剧
夜店狂欢,夜店,青春片,都市剧
```

### JSON 格式示例

```json
[
  {
    "标准词": "测试场景A",
    "原词": "测试场景A",
    "适配类型": ""
  },
  {
    "标准词": "测试场景B",
    "原词": "测试B",
    "适配类型": ["动作片", "悬疑片"]
  },
  {
    "标准词": "咖啡厅闲聊",
    "原词": "闲聊",
    "适配类型": ["都市剧"]
  },
  {
    "标准词": "夜店狂欢",
    "原词": "夜店",
    "适配类型": ["青春片", "都市剧"]
  }
]
```
