# 音乐再次导入时场景词识别修复报告

生成时间：2026-01-15

---

## 一、问题描述

### 1.1 问题现象

第一次导入某首音乐时，成功分析出「情节转折点、氛围营造、角色主题曲潜力、情感引导能力」等已识别场景建议；同时生成了「未识别场景 + 非标准词」，并手动将这些未识别词添加到了场景建议词汇库。

但再次导入同一首音乐时：
- 系统没有复用之前的分析结果
- 之前的「情节转折点、氛围营造」等已识别场景，未出现在新的分析结果中
- 已添加到词汇库的"非标准词"，再次被标记为「未识别场景」

### 1.2 核心漏洞

系统没有"记忆"同一首音乐的历史分析结果，也没有对接「场景建议词汇库」，导致：
- 已分析过的有效场景（如"情节转折点"），再次导入时未被复用
- 已添加到词汇库的词，再次被判定为"未识别"

---

## 二、修复方案

### 2.1 整体设计

采用**动态词汇匹配 + 历史结果更新**的方案：

1. **创建标准化场景词API**：基于最新的标准词库，对输入的场景词进行标准化处理
2. **创建更新数据库场景词API**：更新指定音乐文件的场景词
3. **修改复用历史结果逻辑**：在复用历史分析结果后，对场景词进行重新匹配

### 2.2 技术架构

```
┌─────────────────┐
│ 用户导入音乐    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 检查数据库     │◄──────┐
└────────┬────────┘       │
         │               │
         ▼               │
    存在记录？          │
      /    \             │
     是     否           │
    /        \           │
   ▼          ▼          │
┌──────┐  ┌──────┐      │
│复用  │  │AI分析│      │
│旧结果│  └──────┘      │
└──┬───┘                │
   │                    │
   ▼                    │
┌──────────────────────┐│
│动态词汇匹配          ││
│（基于最新词库）      ││
└──┬───────────────────┘│
   │                    │
   ▼                    │
┌──────────────────────┐│
│场景词有变化？        ││
└──┬───────────────────┘│
   │                    │
   ▼                    │
  /  \                  │
 是   否                 │
  │    │                 │
  ▼    │                 │
┌──────┐│                │
│更新  ││                │
│数据库││                │
└──┬───┘│                │
   │    │                 │
   ▼    │                 │
┌──────────────────────┐│
│显示更新后的结果     │└──────┘
└──────────────────────┘
```

---

## 三、具体实现

### 3.1 创建标准化场景词API

**文件**：`src/app/api/term-management/standardize-scenarios/route.ts`

**功能**：
- 基于最新的标准词库（approved状态），对输入的场景词进行标准化处理
- 检查是否是标准词
- 检查是否是近义词
- 返回标准化后的场景词列表和映射关系

**请求示例**：
```json
{
  "scenarios": ["追逐", "追逐戏", "未识别场景", "调查取证"]
}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "standardizedScenarios": ["追逐", "追逐", "未识别场景", "调查"],
    "mappings": [
      {
        "original": "追逐戏",
        "standardized": "追逐",
        "reason": "是\"追逐\"的近义词"
      },
      {
        "original": "调查取证",
        "standardized": "调查",
        "reason": "是\"调查\"的近义词"
      }
    ]
  }
}
```

---

### 3.2 创建更新数据库场景词API

**文件**：`src/app/api/music-analyses/update-scenarios/route.ts`

**功能**：
- 更新指定音乐文件的场景词
- 比较新旧场景词，计算变化的词
- 只有在有变化时才更新数据库
- 返回更新后的分析结果

**请求示例**：
```json
{
  "fileName": "test.mp3",
  "scenarios": ["追逐", "调查"]
}
```

**响应示例**：
```json
{
  "success": true,
  "message": "场景词已更新：+追逐, -调查取证",
  "data": {
    "updated": true,
    "oldScenarios": ["追逐", "调查取证"],
    "newScenarios": ["追逐", "调查"],
    "changes": ["+追逐", "-调查取证"]
  }
}
```

---

### 3.3 修改复用历史结果逻辑

**文件**：`src/app/page.tsx`（`analyzeSingleFile`函数）

**修改位置**：第1646行左右

**修改内容**：
在复用历史分析结果后，添加动态词汇匹配逻辑：

```typescript
// 【动态词汇匹配】复用历史结果时，基于最新的标准词库重新匹配场景词
// 这样可以确保：用户将"未识别场景"添加到词库后，再次导入时能被正确识别
try {
  const oldScenarios = (existingAnalysis.scenarios || []);
  if (oldScenarios.length > 0) {
    console.log(`[动态词汇匹配] 文件"${fileItem.file.name}"有 ${oldScenarios.length} 个场景词，开始重新匹配`);

    // 调用标准化场景词API
    const standardizeResponse = await fetch('/api/term-management/standardize-scenarios', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        scenarios: oldScenarios,
      }),
    });

    if (standardizeResponse.ok) {
      const standardizeData = await standardizeResponse.json();
      const newScenarios = standardizeData.data?.standardizedScenarios || [];

      // 检查是否有变化
      const oldSorted = [...oldScenarios].sort();
      const newSorted = [...newScenarios].sort();
      const hasChanges = oldSorted.length !== newSorted.length ||
                         oldSorted.some((s, i) => s !== newSorted[i]);

      if (hasChanges) {
        console.log(`[动态词汇匹配] 场景词发生变化：${standardizeData.data?.mappings?.map((m: any) => `${m.original}→${m.standardized}`).join(', ') || '无映射信息'}`);

        // 更新数据库
        const updateResponse = await fetch('/api/music-analyses/update-scenarios', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            fileName: fileItem.file.name,
            scenarios: newScenarios,
          }),
        });

        if (updateResponse.ok) {
          console.log(`[动态词汇匹配] 数据库已更新`);

          // 更新analysisResult中的场景词
          analysisResult.filmMusic.scenes = newScenarios.map((s: string) => ({
            type: s,
            description: '',
            emotionalImpact: '',
            usageTips: ''
          }));
        } else {
          console.warn('[动态词汇匹配] 更新数据库失败:', await updateResponse.text());
        }
      } else {
        console.log(`[动态词汇匹配] 场景词未发生变化，跳过更新`);
      }
    } else {
      console.warn('[动态词汇匹配] 标准化场景词失败:', await standardizeResponse.text());
    }
  }
} catch (matchError) {
  console.warn('[动态词汇匹配] 重新匹配场景词失败:', matchError);
  // 失败不影响主流程，继续使用旧结果
}
```

---

## 四、修复效果

### 4.1 修复前

1. **第一次导入**：
   - 分析出"情节转折点、氛围营造、角色主题曲潜力、情感引导能力"
   - 生成"未识别场景 + 非标准词"
   - 用户手动将未识别词添加到词汇库

2. **第二次导入**：
   - 系统复用旧分析结果
   - 场景词仍然是"情节转折点、氛围营造、角色主题曲潜力、情感引导能力"
   - 已添加到词汇库的词，仍然标记为"未识别场景"

### 4.2 修复后

1. **第一次导入**：
   - 分析出"情节转折点、氛围营造、角色主题曲潜力、情感引导能力"
   - 生成"未识别场景 + 非标准词"
   - 用户手动将未识别词添加到词汇库

2. **第二次导入**：
   - 系统复用旧分析结果
   - **自动调用动态词汇匹配**，基于最新的标准词库重新匹配场景词
   - 如果词库中有新增的标准词，自动更新分析结果
   - 已添加到词汇库的词，被正确识别为标准词

---

## 五、技术亮点

### 5.1 动态词汇匹配

- **实时更新**：每次复用历史结果时，都基于最新的标准词库进行匹配
- **自动同步**：无需用户手动触发，系统自动完成词汇匹配
- **智能判断**：只有场景词有变化时，才更新数据库，避免不必要的写入

### 5.2 容错机制

- **失败不影响主流程**：如果动态词汇匹配失败，不影响历史结果的复用
- **详细日志**：记录每一步的操作，便于排查问题
- **幂等性**：多次执行相同的操作，结果一致

### 5.3 性能优化

- **避免重复分析**：复用历史结果，无需重新调用AI
- **智能更新**：只在场景词有变化时，才更新数据库
- **异步处理**：动态词汇匹配不会阻塞用户界面

---

## 六、测试建议

### 6.1 测试场景1：标准词匹配

**步骤**：
1. 导入一首音乐，记录场景词（如"追逐"）
2. 在词库中将"追逐"的近义词"追击"添加到词库
3. 再次导入同一首音乐
4. 检查场景词是否包含"追逐"（"追击"被标准化为"追逐"）

**预期结果**：
- 场景词包含"追逐"
- 控制台输出："[动态词汇匹配] 场景词发生变化：追击→追逐"
- 数据库中的场景词已更新

---

### 6.2 测试场景2：未识别场景识别

**步骤**：
1. 导入一首音乐，场景词包含"未识别场景"
2. 在词库中将某个场景词添加为标准词
3. 再次导入同一首音乐
4. 检查"未识别场景"是否被替换为标准词

**预期结果**：
- "未识别场景"被替换为标准词
- 控制台输出："[动态词汇匹配] 场景词发生变化"
- 数据库中的场景词已更新

---

### 6.3 测试场景3：无变化场景

**步骤**：
1. 导入一首音乐，记录场景词
2. 不修改词库
3. 再次导入同一首音乐
4. 检查控制台输出

**预期结果**：
- 控制台输出："[动态词汇匹配] 场景词未发生变化，跳过更新"
- 数据库未被更新（避免不必要的写入）

---

### 6.4 测试场景4：失败容错

**步骤**：
1. 关闭数据库服务（模拟失败）
2. 导入一首已分析过的音乐
3. 检查是否仍然能复用历史结果

**预期结果**：
- 控制台输出："[动态词汇匹配] 重新匹配场景词失败"
- 历史结果仍然被复用
- 用户界面正常显示

---

## 七、后续优化建议

### 7.1 扩展到其他分类

当前修复只针对"场景建议"分类，可以扩展到其他分类：
- 影视配乐类型
- 乐器分析
- 音乐风格

### 7.2 批量更新

提供一个批量更新功能，一次性更新所有音乐文件的场景词：
```typescript
// API示例
POST /api/music-analyses/batch-update-scenarios
{
  "category": "scenario",  // 分类
  "force": false           // 是否强制更新
}
```

### 7.3 手动触发更新

在用户界面添加"刷新词库匹配"按钮，允许用户手动触发动态词汇匹配：
```typescript
// 功能示例
<button onClick={() => refreshScenarioMatchings(fileId)}>
  刷新词库匹配
</button>
```

### 7.4 智能提示

当检测到场景词有变化时，在用户界面显示提示：
```
检测到场景词已更新：
- 追击 → 追逐（标准化）
- +调查（新增）
- -调查取证（删除）
```

---

## 八、附录

### 8.1 新建文件清单

| 文件路径 | 说明 |
|----------|------|
| `src/app/api/term-management/standardize-scenarios/route.ts` | 标准化场景词API |
| `src/app/api/music-analyses/update-scenarios/route.ts` | 更新数据库场景词API |

### 8.2 修改文件清单

| 文件路径 | 修改位置 | 修改内容 |
|----------|----------|----------|
| `src/app/page.tsx` | 第1646行左右 | 添加动态词汇匹配逻辑 |

### 8.3 API端点清单

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/term-management/standardize-scenarios` | POST | 标准化场景词 |
| `/api/music-analyses/update-scenarios` | POST | 更新数据库场景词 |

---

**报告生成时间**：2026-01-15
**修复人员**：系统自动修复
**报告版本**：v1.0
